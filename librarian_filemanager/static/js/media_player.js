// Generated by CoffeeScript 1.10.0
(function(window, $, templates) {
  'use strict';
  var audioData, coverClass, currentItemClass, customCoverClass, mediaPlayer, selectors;
  audioData = JSON.parse($("#audioData").html());
  currentItemClass = 'playlist-list-item-current';
  coverClass = 'audio-controls-cover';
  customCoverClass = 'audio-controls-custom-cover';
  selectors = {
    itemSelector: '#playlist-list .playlist-list-item',
    currentItemClass: currentItemClass,
    currentItemSelector: '.' + currentItemClass,
    coverClass: coverClass,
    coverSelector: '.' + coverClass,
    customCoverClass: customCoverClass,
    customCoverSelector: '.' + customCoverClass
  };
  mediaPlayer = {
    initialize: function(container, features, callbacks) {
      var defaultCallbacks;
      this.container = container;
      defaultCallbacks = {
        setCurrent: (function(_this) {
          return function(current, previous) {
            _this.onSetCurrent(current, previous);
          };
        })(this)
      };
      this.options = $.extend({}, selectors, features, defaultCallbacks, callbacks);
      this.details = (container.find('#playlist-metadata')).first();
      this.readyPlayer();
    },
    onPlayerReady: function(mediaElement) {
      this.player = mediaElement;
      ($(window)).on('views-sidebar-toggled', (function(_this) {
        return function() {
          _this.sidebarToggled();
        };
      })(this));
      this.playlist = new Playlist(this.container, this.options);
    },
    onSetCurrent: function(current, previous) {
      var autoPlay, nextUrl, previousUrl;
      previousUrl = previous.data('url');
      nextUrl = current.data('url');
      autoPlay = previousUrl !== nextUrl;
      this.updatePlayer(current, autoPlay);
      this.updateDetails(current);
      previousUrl = previous.data('url');
      nextUrl = current.data('url');
      if (previousUrl !== nextUrl) {
        window.changeLocation(nextUrl);
      }
    },
    updateCover: function(url, defaultUrl) {
      var res;
      res = $.get(url);
      return res.done(function(data) {
        var cover;
        cover = $(selectors.coverSelector);
        if (data.url) {
          cover.attr('src', data.url);
          return cover.addClass(selectors.customCoverClass);
        } else {
          cover.attr('src', defaultUrl);
          return cover.removeClass(selectors.customCoverClass);
        }
      });
    },
    updatePlayer: function(item, autoPlay) {
      var mediaUrl, wasPlaying;
      mediaUrl = item.data('direct-url');
      this.updateCover(item.data('get-thumb-url'), audioData.defaultThumbUrl);
      wasPlaying = !this.player.paused;
      if (wasPlaying) {
        this.player.pause();
      }
      this.player.setSrc(mediaUrl);
      if (wasPlaying || autoPlay) {
        this.player.play();
      }
    },
    updateDetails: function(item) {
      var metaUrl;
      metaUrl = item.data('meta-url');
      return this.details.load(metaUrl);
    },
    next: function() {
      this.playlist.next();
    },
    previous: function() {
      this.playlist.previous();
    },
    sidebarToggled: function() {
      this.triggerResizeEvents(100, 1000);
    },
    triggerResizeEvents: function(interval, duration) {

      /*
      Trigger window resize event every `interval` milliseconds for
      `duration` milliseconds
       */
      var end, resizeFunc, start;
      if (this.resizeTimerId) {
        window.clearInterval(this.resizeTimerId);
      }
      start = Date.now();
      end = start + duration;
      resizeFunc = function() {
        $(window).trigger('resize');
        if (Date.now() >= end) {
          window.clearInterval(this.resizeTimerId);
        }
      };
      resizeFunc = resizeFunc.bind(this);
      this.resizeTimerId = window.setInterval(resizeFunc, 100);
    }
  };
  return window.mediaPlayer = mediaPlayer;
})(this, this.jQuery, this.templates);
