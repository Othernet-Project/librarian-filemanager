// Generated by CoffeeScript 1.10.0
(function(window, $, templates) {
  'use strict';
  var Gallery, prepareGallery;
  Gallery = (function() {
    var currentItemClass;

    currentItemClass = 'gallery-list-item-current';

    function Gallery(container) {
      var i, image, index, len, ref;
      this.container = container;
      this.currentImage = this.container.find('.gallery-current-image-img').first();
      this.currentImageLabel = this.container.find('#gallery-controls-image-title').first();
      this.imagesList = this.container.find('#gallery-list .gallery-list-item');
      this.currentIndex = 0;
      ref = this.imagesList;
      for (index = i = 0, len = ref.length; i < len; index = ++i) {
        image = ref[index];
        if ($(image).hasClass(currentItemClass)) {
          this.currentIndex = index;
          break;
        }
      }
      this.moveTo(this.currentIndex);
      this.imagesList.on('click', 'a', (function(_this) {
        return function(e) {
          _this.onClick(e);
        };
      })(this));
    }

    Gallery.prototype.updateImage = function(newIndex) {
      var image_url, item, prevItem, title;
      prevItem = $(this.imagesList.get(this.currentIndex));
      prevItem.removeClass(currentItemClass);
      this.currentIndex = newIndex;
      item = $(this.imagesList.get(this.currentIndex));
      item.addClass(currentItemClass);
      title = item.data('title');
      image_url = item.data('direct-url');
      this.currentImage.attr({
        'src': image_url,
        'title': title,
        'alt': title
      });
      this.currentImageLabel.html(title);
    };

    Gallery.prototype.updateLocation = function() {
      var item, url;
      item = $(this.imagesList.get(this.currentIndex));
      url = item.data('url');
      window.history.pushState(null, null, url);
    };

    Gallery.prototype.moveTo = function(index) {
      if (index < 0 || index >= this.imagesList.length) {
        return;
      }
      this.updateImage(index);
      this.updateLocation();
    };

    Gallery.prototype.next = function() {
      var index;
      index = (this.currentIndex + 1) % this.imagesList.length;
      return this.moveTo(index);
    };

    Gallery.prototype.previous = function() {
      var index;
      index = (this.imagesList.length + this.currentIndex - 1) % this.imagesList.length;
      return this.moveTo(index);
    };

    Gallery.prototype.onClick = function(e) {
      var item;
      e.preventDefault();
      e.stopPropagation();
      item = $(e.target).closest('li');
      this.moveTo(this.imagesList.index(item));
      return false;
    };

    return Gallery;

  })();
  prepareGallery = function() {
    var gallery, galleryContainer;
    galleryContainer = $('#gallery-container');
    if (!!galleryContainer.length) {
      return;
    }
    gallery = new Gallery(galleryContainer);
    $('#gallery-controls-control-previous').click(function() {
      gallery.previous();
    });
    $('#gallery-controls-control-next').click(function() {
      gallery.next();
    });
  };
  $(prepareGallery);
  window.onTabChange(prepareGallery);
})(this, this.jQuery);
